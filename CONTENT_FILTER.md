# 内容过滤功能说明

## 功能概述

现在支持通过 `description` 参数对笔记进行内容过滤，让 GPT-4o Vision 只选择符合特定描述的笔记。

## 工作原理

### 流程图

```
用户提供 keyword + description
          ↓
    搜索 keyword
          ↓
   注入 SoM 标记
          ↓
      截图页面
          ↓
  GPT-4o 分析封面和标题
          ↓
 只返回符合 description 的笔记 ID
          ↓
    点击这些笔记
```

## 使用方法

### 1. 在 main.py 中配置

```python
keyword = "豚鼠肉"
description = "只选择展示豚鼠肉烹饪、制作过程或成品菜肴的笔记，排除文字介绍、旅游攻略等内容"
max_notes = 10
total_rounds = 3
browse_images_count = 5
```

### 2. description 参数说明

**格式**：清晰描述你想要的笔记内容

**示例**：

#### 示例 1: 美食制作
```python
keyword = "鱼香肉丝"
description = "只选择展示鱼香肉丝制作过程或成品的笔记，必须包含烹饪步骤或菜品照片"
```

#### 示例 2: 旅游攻略
```python
keyword = "丽江"
description = "只选择丽江古城游玩攻略，包含景点推荐、路线规划的笔记，排除单纯的美食或住宿推荐"
```

#### 示例 3: 产品评测
```python
keyword = "iPhone 15"
description = "只选择 iPhone 15 真机评测、性能测试、拍照对比的笔记，排除开箱视频和配件推荐"
```

#### 示例 4: 穿搭分享
```python
keyword = "秋季穿搭"
description = "只选择展示实际穿搭效果的笔记，必须有真人试穿照片，排除单品展示和穿搭文字建议"
```

### 3. 不使用过滤（保持原有行为）

如果不需要内容过滤，保持 `description` 为空字符串即可：

```python
keyword = "豚鼠肉"
description = ""  # 空字符串，不进行内容过滤
max_notes = 10
```

## 技术实现

### 修改的文件

1. **[main.py:44](main.py#L44)** - 添加 `description` 参数
2. **[main.py:93](main.py#L93)** - 传递 `content_description` 到 click_graph
3. **[agent/state.py:53](agent/state.py#L53)** - 添加 `content_description` 字段
4. **[agent/graph.py:99](agent/graph.py#L99)** - 接收 `content_description` 参数
5. **[agent/click_nodes.py:23](agent/click_nodes.py#L23)** - 传递给 SoM locator
6. **[core/som_vision_locator.py:43](core/som_vision_locator.py#L43)** - 修改 `locate_note_cards` 接收参数
7. **[core/som_vision_locator.py:166](core/som_vision_locator.py#L166)** - 修改 prompt 添加内容过滤逻辑

### Prompt 改进

当提供 `description` 时，GPT-4o Vision 的 prompt 会包含：

```
**🎯 内容过滤要求（非常重要）**：
{用户提供的描述}

**你必须**：
1. 仔细观察每个标记对应的笔记封面图和标题
2. 只选择**符合上述内容描述**的笔记标记
3. 如果笔记内容与描述不符，**不要选择该标记**
4. 优先选择封面图和描述最匹配的笔记
5. **宁可少选，不要选错**
```

### 过滤机制

GPT-4o Vision 会：
1. 观察每个笔记的**封面图**
2. 阅读每个笔记的**标题文字**
3. 判断内容是否符合 `description`
4. 只返回符合描述的笔记 ID
5. 如果没有符合的笔记，返回空数组 `[]`

## 最佳实践

### 1. 描述要具体

❌ **不好**：
```python
description = "好的笔记"
```

✅ **好**：
```python
description = "只选择展示实际烹饪过程的笔记，必须有分步骤的制作照片"
```

### 2. 明确排除条件

✅ **推荐**：
```python
description = "只选择真实旅游体验分享，包含实拍照片和具体建议，排除纯文字攻略和景点介绍"
```

### 3. 关注视觉元素

记住 GPT-4o Vision 主要通过**封面图**和**标题**判断，所以描述应该关注这些可见元素：

✅ **好**：
```python
description = "封面图必须展示成品菜肴，可以看到完整的摆盘和配菜"
```

❌ **不好**（无法通过封面判断）：
```python
description = "只选择口感好、味道正宗的菜谱"
```

### 4. 合理设置 max_notes

使用内容过滤时，实际返回的笔记数量可能小于 `max_notes`（因为过滤掉了不符合的）：

```python
max_notes = 15  # 设置稍大一些
description = "..."  # 严格的过滤条件
# 实际可能只返回 5-8 个符合条件的笔记
```

## 性能影响

### Token 消耗

使用内容过滤时，prompt 会稍微变长（约增加 100-200 tokens），但：
- ✅ 过滤掉不相关的笔记，减少后续处理
- ✅ 提高数据质量
- ✅ 总体上更节省时间和资源

### 准确率

内容过滤的准确率取决于：
1. **描述的清晰度**：越具体越准确
2. **封面图的代表性**：封面能反映内容的准确率更高
3. **标题的相关性**：标题明确的更容易判断

典型准确率：**85-95%**（基于 GPT-4o Vision 的视觉理解能力）

## 调试技巧

### 查看日志

运行时会显示：

```
🎯 使用 SoM 方案识别笔记（最多 10 个，过滤条件: 只选择展示豚鼠肉烹饪、制作过程或成品菜肴的笔记...）
   - 正在调用 GPT-4o Vision 识别标记...
✅ GPT-4o 识别到 5 个标记: [1, 3, 5, 7, 9]
🎯 成功定位 5 个笔记元素
```

如果识别数量远少于 `max_notes`，说明过滤条件较严格。

### 调整策略

如果识别到的笔记太少：
1. **放宽描述**：减少限制条件
2. **增加 max_notes**：提供更多候选
3. **检查关键词**：确保搜索关键词准确

如果识别到不相关的笔记：
1. **细化描述**：添加更具体的要求
2. **添加排除条件**：明确不要什么
3. **强调视觉特征**：关注封面图的特点

## 示例场景

### 场景 1: 收集美食制作笔记

```python
keyword = "宫保鸡丁"
description = "只选择展示宫保鸡丁完整制作过程的笔记，必须包含烹饪步骤照片，排除只有成品图或文字菜谱"
max_notes = 12
total_rounds = 2
```

**预期结果**：只点击包含制作步骤的笔记

### 场景 2: 收集真实测评

```python
keyword = "戴森吹风机"
description = "只选择真实使用体验和效果对比的笔记，必须有实拍使用场景，排除开箱和产品展示"
max_notes = 10
total_rounds = 3
```

**预期结果**：只点击包含使用测评的笔记

### 场景 3: 收集旅游攻略

```python
keyword = "稻城亚丁"
description = "只选择包含实际游玩路线、时间安排、注意事项的攻略笔记，必须有实拍景点照片"
max_notes = 15
total_rounds = 2
```

**预期结果**：只点击实用攻略笔记，排除单纯的美图分享

## 注意事项

1. **内容过滤是辅助功能**，不能 100% 保证完全准确
2. **描述应该基于视觉可见的内容**（封面图 + 标题）
3. **过滤条件太严格可能导致返回笔记很少**
4. **建议先用较宽松的条件测试**，然后逐步调整

## 回退到无过滤模式

如果不需要内容过滤，只需设置空字符串：

```python
description = ""  # 不进行内容过滤，返回所有识别到的笔记
```

系统会自动使用原始的 SoM prompt，不包含内容过滤逻辑。

## 总结

内容过滤功能通过让 GPT-4o Vision 理解笔记的封面图和标题，实现了智能的内容筛选，大幅提高了数据收集的精准度和效率。
