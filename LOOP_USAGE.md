# 循环点击功能使用说明

## 功能概述

现在支持执行完所有点击操作后，自动滚动页面并重复"截图分析 → 点击操作"的循环流程。

## 工作流程

```plaintext
第1轮:
  1. 截图并识别坐标 (collect_coordinates)
  2. 对每个识别到的笔记:
     a. 点击笔记进入详情页 (click_coordinate)
     b. 按N次右键浏览图片 (browse_images)
     c. 按ESC返回搜索页 (press_escape)
  3. 滚动页面加载更多内容 (scroll_and_wait)

第2轮:
  4. 重新截图并识别新的坐标 (collect_coordinates)
  5. 对每个新识别的笔记重复步骤2
  6. 再次滚动页面...

... 重复直到完成所有轮次
```

## 配置参数

在 `main.py` 中修改以下参数：

```python
keyword = "鱼香肉丝"          # 搜索关键词
max_notes = 10               # 每轮最多点击的笔记数量
total_rounds = 3             # 总共执行的轮次
browse_images_count = 5      # 每个笔记进入详情页后按右键浏览图片的次数
```

### 参数说明

- `max_notes`: 每轮最多点击多少个笔记
  - 例如：`max_notes=10` 表示每轮点击10个笔记

- `total_rounds`: 总共执行多少轮
  - `total_rounds=1`: 不循环，只执行一次（默认）
  - `total_rounds=3`: 执行3轮（点击 → 滚动 → 点击 → 滚动 → 点击）
  - `total_rounds=5`: 执行5轮，依此类推

- `browse_images_count`: 进入笔记详情页后按右键浏览图片的次数
  - `browse_images_count=5`: 按5次右键，浏览5张图片（默认）
  - `browse_images_count=0`: 不浏览图片，直接返回
  - `browse_images_count=10`: 按10次右键，适合图片较多的笔记

## 使用示例

### 示例 1: 单次执行（不循环）

```python
max_notes = 10
total_rounds = 1  # 只执行一次
browse_images_count = 5
```

**结果**：识别并点击10个笔记，每个笔记进入详情页后按5次右键浏览图片

### 示例 2: 执行3轮（带图片浏览）

```python
max_notes = 10
total_rounds = 3
browse_images_count = 5
```

**结果**：

- 第1轮：点击10个笔记，每个笔记浏览5张图片
- 滚动页面
- 第2轮：点击新的10个笔记，每个笔记浏览5张图片
- 滚动页面
- 第3轮：点击新的10个笔记，每个笔记浏览5张图片
- 总计：30个笔记，150次按键操作

### 示例 3: 小批量多轮次（不浏览图片）

```python
max_notes = 5
total_rounds = 6
browse_images_count = 0  # 不浏览图片
```

**结果**：每轮点击5个，执行6轮，总计30个笔记，快速验证点击是否成功

### 示例 4: 深度浏览模式

```python
max_notes = 5
total_rounds = 2
browse_images_count = 10  # 每个笔记看10张图片
```

**结果**：总计10个笔记，每个笔记深度浏览10张图片

## 滚动行为

每轮完成后，系统会自动：
1. 将鼠标移动到页面中央
2. 模拟人类滚动行为（3-5次随机幅度的滚动）
3. 等待2秒让新内容加载
4. 进入下一轮识别和点击

## 统计信息

执行完成后会显示：

```
📊 点击结果
============================================================
   - 执行轮次: 3/3
   - 累计识别坐标: 30
   - 累计点击: 28
   - 累计失败: 2
   - 可能进入详情页: 25
```

## 图片浏览行为

当成功进入笔记详情页后，系统会：

1. 等待0.5秒让页面稳定
2. 按右键（`ArrowRight`）切换到下一张图片
3. 每次按键后随机停顿 0.4-0.8 秒，模拟人类浏览
4. 重复步骤2-3，直到达到设定的次数
5. 按 ESC 返回搜索页

**执行示例**（`browse_images_count=5`）：

```plaintext
进入详情页 → 等待0.5秒 →
按右键(1) → 停顿0.6秒 →
按右键(2) → 停顿0.5秒 →
按右键(3) → 停顿0.7秒 →
按右键(4) → 停顿0.4秒 →
按右键(5) → 停顿0.8秒 →
按ESC返回
```

## 注意事项

1. **合理设置轮次**：过多轮次会消耗大量 API 调用（Vision API）
2. **避免重复点击**：系统会自动滚动加载新内容，但不保证完全不重复
3. **观察执行**：建议先设置较小的轮次（如2-3轮）测试效果
4. **API 成本**：每轮都会调用 GPT-4o Vision 进行截图分析
5. **图片浏览时间**：
   - `browse_images_count=5` 大约需要 2.5-4 秒
   - `browse_images_count=10` 大约需要 4.5-8 秒
   - 设置为 0 可跳过图片浏览，仅验证点击功能
6. **适配不同笔记**：
   - 图片笔记：建议设置 `browse_images_count=5-10`
   - 视频笔记：右键可能无效果，建议设置 `browse_images_count=0`
   - 文字笔记：右键通常无效果

## 代码位置

- 循环逻辑: `agent/graph.py`
- 滚动节点: `agent/click_nodes.py` 中的 `scroll_and_wait_node`
- 状态定义: `agent/state.py` 中的 `ClickGraphState`
- 主入口: `main.py`
